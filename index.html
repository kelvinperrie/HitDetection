<!DOCTYPE html>
<html>
    <head>
        <title>hit me</title>
        <style>
            
            body {
                font-family: 'Hind Siliguri', sans-serif !important;
            }
            canvas {
                border: 1px solid #d0d0d0;
                background-color: #fff;
            }
        </style>
    </head>
    <body>
        <div class="angle-increase">angle increase</div>
        <div class="angle-decrease">angle decrease</div>
        <canvas id="canvas" width="1400" height="600"></canvas>
        <script src="jquery-3.3.1.min.js"></script>
        <script>

            var HitMarkerCircle = function(parent, left, top, size) {
                var self = this;

                self.parent = parent;
                self.top = top;
                self.left = left;
                self.size = size;
                self.currentHit = false;

                self.x = self.parent.position.x + self.left;
                self.y = self.parent.position.y + self.top;

                self.distanceFromCenter = Math.sqrt(self.left * self.left + self.top * self.top);
                
                self.initialAngle = Math.atan2(self.top , self.left) * 180/Math.PI;

                self.UpdatePosition = function() {
                    var theta_radians = (self.parent.currentAngle + self.initialAngle) * (Math.PI/180);

                    // what is the adjacent (X)
                    var adjacent = Math.cos(theta_radians) * self.distanceFromCenter;
                    // what is the opposite (Y)
                    var opposite = Math.sin(theta_radians) * self.distanceFromCenter;

                    self.x = self.parent.position.x + adjacent;
                    self.y = self.parent.position.y + opposite;
                };
                self.UpdatePosition();  // align with the inital angle of the parent

                self.CheckForHit = function(x, y) {
                    // get the distance between the two points
                    var deltaX = self.x - x;
                    var deltaY = self.y - y;
                    var distanceBetween = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                    //console.log(deltaX + ", " + deltaY + ", " + distanceBetween);
                    if (distanceBetween < self.size) {
                        self.currentHit = true;
                    } else {
                        self.currentHit = false;
                    }
                };

                self.Draw = function(ctx) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.strokeStyle = self.currentHit ? "#FF0000" : "#000000";
                    //ctx.moveTo(self.startPoint.x, self.startPoint.y);
                    //console.log("left: " + marker.x + "; top: " + marker.y + "; size: " + marker.size )
                    ctx.arc(self.x, self.y, self.size, 0, 2 * Math.PI);
                    ctx.stroke();
                    ctx.restore();
                }
            };

            var RocketModel = function(source, target) {
                var self = this;

                self.target = target;

            };

            var RocketLauncherModel = function(source, target) {
                var self = this;

                self.Fire = () => {
                    console.log("firing!");
                };
                setTimeout(self.Fire, 3000);
            };

            var ThingToHitModel = function(startPosition, hitMarkers, positionOnCircle, angleOfDirection) {
                var self = this;

                self.position = startPosition;
                self.hitMarkers = [];
                self.currentAngle = positionOnCircle; //270;  // direction we are facing
                self.directionAngle = angleOfDirection; //0;

                self.weapons = [];

                //self.weapons.push(new RocketLauncherModel(self, ));

                self.ChangeAngle = function(angleDelta) {
                    self.currentAngle = self.currentAngle + angleDelta;
                    console.log(self.currentAngle);
                    self.UpdateMarkerPositions();
                };

                self.UpdateMarkerPositions = function() {
                    for(var i = 0; i < self.hitMarkers.length; i++) {
                        self.hitMarkers[i].UpdatePosition();
                    }
                };

                self.CheckForHit = function(x, y) {
                    for(var i = 0; i < self.hitMarkers.length; i++) {
                        self.hitMarkers[i].CheckForHit(x, y);
                    }
                };

                self.Move = function() {
                    // we're just going to fly in a circle I guess
                    var distanceFromCenter = 200;
                    var centerOfCircle = {
                        x : 250,
                        y : 250
                    };
                    var angleIncrement = 1;

                    self.directionAngle = self.directionAngle + angleIncrement;
                    self.currentAngle = self.currentAngle + angleIncrement;

                    var theta_radians = self.directionAngle * (Math.PI/180);
                    // what is the adjacent (X)
                    var adjacent = Math.cos(theta_radians) * distanceFromCenter;
                    // what is the opposite (Y)
                    var opposite = Math.sin(theta_radians) * distanceFromCenter;
                    self.position.x = centerOfCircle.x + adjacent;
                    self.position.y = centerOfCircle.y + opposite;
                    self.UpdateMarkerPositions();
                }

                self.Draw = function(ctx) {
                    // draw the hit markers
                    for(var i = 0; i < self.hitMarkers.length; i++) {
                        self.hitMarkers[i].Draw(ctx);
                    }
                    // put a center point on
                    ctx.save();
                    ctx.fillRect(self.position.x - 2, self.position.y - 2, 4, 4)
                    ctx.restore();
                };

                self.Initialize = function() {
                    for(var i = 0; i < hitMarkers.length; i++) {
                        if(hitMarkers[i].type === "circle") {
                            self.hitMarkers.push(new HitMarkerCircle(self, hitMarkers[i].left, hitMarkers[i].top, hitMarkers[i].size ));
                        }
                    }
                };
                self.Initialize();
            };

            var PageModel = function() {
                var self = this;

                self.canvas = document.getElementById('canvas');
                self.ctx = self.canvas.getContext('2d');
                self.thingsToHit = [];
                self.mousePosition = {
                    x : 0,
                    y : 0
                }

                self.Initialize = function() {
                    var startPosition = {
                        x : 450,
                        y : 250
                    };

                    var hitMarkers = [];
                    hitMarkers.push({ type: "circle", left: 0, top: 0, size: 15 });
                    hitMarkers.push({ type: "circle", left: 20, top: 0, size: 15 });
                    hitMarkers.push({ type: "circle", left: -20, top: 0, size: 15 });
                    hitMarkers.push({ type: "circle", left: -40, top: 0, size: 15 });
                    hitMarkers.push({ type: "circle", left: 0, top: 20, size: 10 });
                    hitMarkers.push({ type: "circle", left: 0, top: -20, size: 10 });
                    //hitMarkers.push({ type: "rectangle", left: 0, top: 0, height: 30, width: 50 });

                    var thing = new ThingToHitModel(startPosition, hitMarkers, 270, 0);
                    self.thingsToHit.push(thing);

                    
                    startPosition = {
                        x : 50,
                        y : 250
                    };

                    hitMarkers = [];
                    hitMarkers.push({ type: "circle", left: 0, top: 0, size: 40 });
                    hitMarkers.push({ type: "circle", left: 40, top: 20, size: 10 });
                    hitMarkers.push({ type: "circle", left: 40, top: -20, size: 10 });

                    thing = new ThingToHitModel(startPosition, hitMarkers, 90 , 180);
                    self.thingsToHit.push(thing);

                }
                self.Initialize();

                self.DrawLoop = function() {
                    self.ctx.clearRect(0, 0, self.canvas.width, self.canvas.height);
                    for(var i = 0; i < self.thingsToHit.length; i++) {
                        self.thingsToHit[i].Draw(self.ctx);
                    }
                    // draw the recorded mouse position
                    self.ctx.save();
                    self.ctx.fillStyle = "#ff0000";
                    self.ctx.fillRect(self.mousePosition.x - 2, self.mousePosition.y - 2, 4, 4)
                    self.ctx.restore();
                    setTimeout(self.DrawLoop, 100);
                }
                self.DrawLoop();

                self.MoveLoop = function() {
                    for(var i = 0; i < self.thingsToHit.length; i++) {
                        self.thingsToHit[i].Move();
                    }
                    setTimeout(self.MoveLoop, 100);
                }
                self.MoveLoop();

                self.HitDetectionLoop = function() {
                    // if we were clever we would only check this is the position has changed (we not clever)
                    for(var i = 0; i < self.thingsToHit.length; i++) {
                        self.thingsToHit[i].CheckForHit(self.mousePosition.x, self.mousePosition.y);
                    }
                    setTimeout(self.HitDetectionLoop, 50);
                };
                self.HitDetectionLoop();

                self.UpdateMousePosition = function(x , y) {
                    self.mousePosition.x = x;
                    self.mousePosition.y = y;
                };
            }
            var pageModel = new PageModel();


            //$("#canvas").on("mousemove", function(event) {
            $("#canvas").on("mousemove", function(event) {
                var posX = $(this).offset().left,
                    posY = $(this).offset().top;
                pageModel.UpdateMousePosition(event.pageX - posX, event.pageY - posY);
            });
            $(".angle-increase").on("click", function(event) {
                pageModel.thingsToHit[0].ChangeAngle(15);
            });
            $(".angle-decrease").on("click", function(event) {
                pageModel.thingsToHit[0].ChangeAngle(-15);
            });

        </script>
    </body>
</html>