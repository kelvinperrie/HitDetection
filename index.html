<!DOCTYPE html>
<html>
    <head>
        <title>hit me</title>
        <style>
            
            body {
                font-family: 'Hind Siliguri', sans-serif !important;
            }
            canvas {
                border: 1px solid #d0d0d0;
                background-color: #fff;
            }
        </style>
    </head>
    <body>
        <div class="angle-increase">angle increase</div>
        <div class="angle-decrease">angle decrease</div>
        <canvas id="canvas" width="1400" height="600"></canvas>
        <script src="jquery-3.3.1.min.js"></script>
        <script>

            var HitMarker = function(parent, left, top, size) {
                var self = this;

                self.parent = parent;
                self.top = top;
                self.left = left;
                self.size = size;
                self.currentHit = false;

                self.x = self.parent.position.x + self.left;
                self.y = self.parent.position.y + self.top;

                self.distanceFromCenter = Math.sqrt(self.left * self.left + self.top * self.top);
                
                self.initialAngle = Math.atan2(self.top , self.left) * 180/Math.PI;

                self.UpdatePosition = function() {
                    var theta_radians = (self.parent.currentAngle + self.initialAngle) * (Math.PI/180);

                    // what is the adjacent (X)
                    var adjacent = Math.cos(theta_radians) * self.distanceFromCenter;
                    // what is the opposite (Y)
                    var opposite = Math.sin(theta_radians) * self.distanceFromCenter;

                    self.x = self.parent.position.x + adjacent;
                    self.y = self.parent.position.y + opposite;
                };
                self.UpdatePosition();  // align with the inital angle of the parent

                self.CheckForHit = function(x, y) {
                    // get the distance between the two points
                    var deltaX = self.x - x;
                    var deltaY = self.y - y;
                    var distanceBetween = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                    //console.log(deltaX + ", " + deltaY + ", " + distanceBetween);
                    if (distanceBetween < self.size) {
                        self.currentHit = true;
                    } else {
                        self.currentHit = false;
                    }
                };
            };

            var ThingToHitModel = function(startPosition, hitMarkers) {
                var self = this;

                self.position = startPosition;
                self.hitMarkers = [];
                self.currentAngle = 90;  // direction we are facing

                self.ChangeAngle = function(angleDelta) {
                    self.currentAngle = self.currentAngle + angleDelta;
                    console.log(self.currentAngle);
                    for(var i = 0; i < self.hitMarkers.length; i++) {
                        self.hitMarkers[i].UpdatePosition();
                    }
                };

                self.CheckForHit = function(x, y) {
                    for(var i = 0; i < self.hitMarkers.length; i++) {
                        self.hitMarkers[i].CheckForHit(x, y);
                    }
                };

                self.Draw = function(ctx) {
                    // draw thi hit markers
                    for(var i = 0; i < self.hitMarkers.length; i++) {
                        //console.log("Drawing hit marker " + i)
                        var marker = self.hitMarkers[i];
                        ctx.save();
                        ctx.beginPath();
                        ctx.strokeStyle = marker.currentHit ? "#FF0000" : "#000000";
                        //ctx.moveTo(self.startPoint.x, self.startPoint.y);
                        //console.log("left: " + marker.x + "; top: " + marker.y + "; size: " + marker.size )
                        ctx.arc(marker.x, marker.y, marker.size, 0, 2 * Math.PI);
                        ctx.stroke();
                        ctx.restore();
                    }
                    // put a center point on
                    ctx.save();
                    ctx.fillRect(self.position.x - 2, self.position.y - 2, 4, 4)
                    ctx.restore();
                };

                self.Initialize = function() {
                    for(var i = 0; i < hitMarkers.length; i++) {
                        self.hitMarkers.push(new HitMarker(self, hitMarkers[i].left, hitMarkers[i].top, hitMarkers[i].size ));
                    }
                };
                self.Initialize();
            };

            var PageModel = function() {
                var self = this;

                self.canvas = document.getElementById('canvas');
                self.ctx = self.canvas.getContext('2d');
                self.thingsToHit = [];
                self.mousePosition = {
                    x : 0,
                    y : 0
                }

                self.Initialize = function() {
                    var startPosition = {
                        x : 700,
                        y : 300
                    };

                    var hitMarkers = [];
                    hitMarkers.push({ left: 0, top: 0, size: 15 });
                    hitMarkers.push({ left: 20, top: 0, size: 15 });
                    hitMarkers.push({ left: -20, top: 0, size: 15 });
                    hitMarkers.push({ left: -40, top: 0, size: 15 });
                    hitMarkers.push({ left: 0, top: 20, size: 10 });
                    hitMarkers.push({ left: 0, top: -20, size: 10 });

                    thing = new ThingToHitModel(startPosition, hitMarkers);
                    self.thingsToHit.push(thing);

                }
                self.Initialize();

                self.DrawLoop = function() {
                    self.ctx.clearRect(0, 0, self.canvas.width, self.canvas.height);
                    for(var i = 0; i < self.thingsToHit.length; i++) {
                        self.thingsToHit[i].Draw(self.ctx);
                    }
                    // draw the recorded mouse position
                    self.ctx.save();
                    self.ctx.fillStyle = "#ff0000";
                    self.ctx.fillRect(self.mousePosition.x - 2, self.mousePosition.y - 2, 4, 4)
                    self.ctx.restore();
                    setTimeout(self.DrawLoop, 100);
                }
                self.DrawLoop();

                self.HitDetectionLoop = function() {
                    // if we were clever we would only check this is the position has changed (we not clever)
                    for(var i = 0; i < self.thingsToHit.length; i++) {
                        self.thingsToHit[i].CheckForHit(self.mousePosition.x, self.mousePosition.y);
                    }
                    setTimeout(self.HitDetectionLoop, 50);
                };
                self.HitDetectionLoop();

                self.UpdateMousePosition = function(x , y) {
                    self.mousePosition.x = x;
                    self.mousePosition.y = y;
                };
            }
            var pageModel = new PageModel();


            //$("#canvas").on("mousemove", function(event) {
            $("#canvas").on("mousemove", function(event) {
                var posX = $(this).offset().left,
                    posY = $(this).offset().top;
                pageModel.UpdateMousePosition(event.pageX - posX, event.pageY - posY);
            });
            $(".angle-increase").on("click", function(event) {
                pageModel.thingsToHit[0].ChangeAngle(15);
            });
            $(".angle-decrease").on("click", function(event) {
                pageModel.thingsToHit[0].ChangeAngle(-15);
            });

        </script>
    </body>
</html>